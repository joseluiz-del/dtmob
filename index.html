<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HXtos CY ‚Ä¢ YardIQ ‚Äî AI Yard Control Matrix (navega√ß√£o interna)</title>
  <style>
    :root{
      --bg:#ffffff;
      --surface:#ffffff;
      --surface2:#f7fbff;
      --ink:#102033;
      --muted:#5f6b7a;

      --line:#e6edf5;
      --line2:#d7e3f2;

      --blue:#0b5ed7;
      --blue-2:#eaf2ff;
      --green:#1f9d66;
      --green-2:#e9fbf3;

      --warn:#f59e0b;
      --warn-2:#fff7e6;
      --danger:#ef4444;
      --danger-2:#fff1f2;

      --shadow: 0 10px 28px rgba(12, 33, 66, .10);
      --shadow2: 0 6px 18px rgba(12, 33, 66, .08);

      --radius:16px;
      --radius2:12px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--ink);
      background:
        radial-gradient(900px 400px at 25% -10%, rgba(11,94,215,.14), transparent 60%),
        radial-gradient(800px 380px at 85% -20%, rgba(31,157,102,.12), transparent 55%),
        linear-gradient(180deg, var(--surface2) 0%, #ffffff 36%, #ffffff 100%);
    }

    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:18px 14px;
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
    }
    .brand{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 10px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: #fff;
      box-shadow: var(--shadow2);
    }
    .logo{
      width:40px;height:40px;border-radius: 12px;
      background: conic-gradient(from 220deg, var(--blue), var(--green), var(--blue));
      box-shadow: 0 10px 22px rgba(11,94,215,.18);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      font-size: 13px;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .brand .sub{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      line-height:1.2;
    }

    .nav{
      margin-top:14px;
      padding:10px 8px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow2);
    }
    .nav a{
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color: #17314a;
      padding:10px 10px;
      border-radius: 12px;
      font-size:12.5px;
      font-weight:800;
      letter-spacing:.1px;
      user-select:none;
      border:1px solid transparent;
    }
    .nav a span.ico{
      width:26px;height:26px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--line2);
      background: linear-gradient(180deg, #ffffff 0%, #f7fbff 100%);
      color:#244a70;
      font-weight:950;
      font-family: var(--mono);
      font-size:12px;
    }
    .nav a:hover{ background:#fbfdff; border-color: rgba(11,94,215,.10); }
    .nav a.active{
      background: linear-gradient(90deg, var(--blue-2), var(--green-2));
      border:1px solid rgba(11,94,215,.18);
    }

    .sidefoot{
      margin-top:14px;
      padding:12px 10px;
      border-radius: var(--radius);
      border:1px dashed var(--line2);
      color:var(--muted);
      font-size:11px;
      line-height:1.35;
      background: rgba(255,255,255,.75);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: linear-gradient(90deg, var(--blue-2), var(--green-2));
      color:#0f2a3a;
      font-size:11px;
      white-space:nowrap;
      margin-top:8px;
    }
    .pill b{font-family:var(--mono); font-weight:950; color:#0b2b55}

    /* Main */
    .main{ padding: 18px 18px 34px; }

    .topbar{
      border:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .crumb{ display:flex; flex-direction:column; gap:6px; }
    .crumb .path{ font-size:11px; color:var(--muted); }
    .crumb .title{ font-size:14px; font-weight:950; letter-spacing:.2px; margin:0; }
    .crumb .desc{ margin:0; color:var(--muted); font-size:11.5px; line-height:1.35; }

    .ctx{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
      align-items:end;
      flex:1 1 auto;
      max-width: 760px;
      margin-left: 10px;
    }
    .field{display:flex;flex-direction:column;gap:6px;min-width:0}
    .field label{font-size:10.5px;color:var(--muted)}
    input,select{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--line2);
      background:#fff;
      outline:none;
      font-size:13px;
      color:var(--ink);
    }
    input:focus, select:focus{
      border-color: rgba(11,94,215,.45);
      box-shadow: 0 0 0 3px rgba(11,94,215,.12);
    }

    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width: 200px;
    }
    .btn{
      border:1px solid var(--line2);
      background:#fff;
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      font-size:12.5px;
      cursor:pointer;
      transition:.15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 22px rgba(12,33,66,.10)}
    .btn.primary{
      border-color: rgba(11,94,215,.30);
      background: linear-gradient(180deg, #ffffff 0%, #f2f7ff 100%);
      color:#093a86;
    }
    .btn.good{
      border-color: rgba(31,157,102,.30);
      background: linear-gradient(180deg, #ffffff 0%, #f1fff8 100%);
      color:#0b5a3a;
    }
    .btn.ghost{
      background:transparent;
      color:var(--muted);
      font-weight:900;
    }

    /* YardIQ internal tabs */
    .subnav{
      margin-top: 12px;
      border:1px solid var(--line);
      background:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      position: sticky;
      top: 14px;
      z-index: 10;
    }
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      border:1px solid var(--line2);
      background:#fff;
      padding:9px 12px;
      border-radius: 999px;
      font-weight:950;
      font-size:12px;
      color:#17314a;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .tab .t{
      width:8px;height:8px;border-radius:99px;background:var(--blue);
      box-shadow: 0 0 0 3px rgba(11,94,215,.10);
    }
    .tab.green .t{ background: var(--green); box-shadow: 0 0 0 3px rgba(31,157,102,.10); }
    .tab.warn .t{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.12); }
    .tab.active{
      background: linear-gradient(90deg, var(--blue-2), var(--green-2));
      border-color: rgba(11,94,215,.18);
    }
    .subtools{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:flex-end;
    }
    .subtools .btn{ padding:9px 12px; border-radius: 999px; min-width:auto; }
    .subtools .btn:hover{ transform:none; }

    .section{
      scroll-margin-top: 92px; /* for sticky subnav */
    }

    /* Content grid */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.35fr .75fr;
      gap:14px;
      align-items:start;
    }

    .card{
      border:1px solid var(--line);
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardhead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
    }
    .cardhead h2{
      margin:0;
      font-size:12.5px;
      letter-spacing:.2px;
      font-weight:950;
    }
    .hint{ color:var(--muted); font-size:11px; line-height:1.25; margin-top:4px; }
    .cardbody{padding:12px 14px}

    .kpirow{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .kpi{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      padding:10px 10px;
      background:#fff;
    }
    .kpi .k{font-size:10.5px;color:var(--muted)}
    .kpi .v{margin-top:6px;font-size:15px;font-weight:950}
    .kpi .v span{font-family:var(--mono);font-weight:950}
    .kpi .s{margin-top:6px;font-size:10.5px;color:var(--muted);line-height:1.25}

    /* Tables */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
    }
    thead th{
      text-align:left;
      color:#12304a;
      font-weight:950;
      font-size:10.5px;
      letter-spacing:.2px;
      padding:10px 10px;
      background: linear-gradient(90deg, var(--blue-2), var(--green-2));
      border-bottom:1px solid var(--line2);
    }
    tbody td{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
    }
    tbody tr:hover td{background:#fbfdff}

    .cell-mini input, .cell-mini select{
      padding:8px 8px;
      border-radius:12px;
      font-size:12px;
    }

    .rowtools{display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .iconbtn{
      border:1px solid var(--line2);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:950;
      color:#244;
    }
    .iconbtn:hover{box-shadow: 0 10px 18px rgba(12,33,66,.10)}
    .iconbtn.danger{border-color: rgba(239,68,68,.25); color:#9b1c1c; background:linear-gradient(180deg,#fff, #fff7f7)}
    .iconbtn.blue{border-color: rgba(11,94,215,.25); color:#0b3f91; background:linear-gradient(180deg,#fff,#f3f8ff)}
    .iconbtn.green{border-color: rgba(31,157,102,.25); color:#0b5a3a; background:linear-gradient(180deg,#fff,#f2fff8)}

    /* Badges */
    .badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 8px; border-radius:999px;
      border:1px solid var(--line2); background:#fff;
      font-size:10.5px; color:#0b2b55; white-space:nowrap;
      font-weight:900;
    }
    .badge .dot{width:8px;height:8px;border-radius:99px;background:var(--blue)}
    .badge.ok{background: var(--green-2); border-color: rgba(31,157,102,.28); color:#0b5a3a}
    .badge.ok .dot{background:var(--green)}
    .badge.warn{background: var(--warn-2); border-color: rgba(245,158,11,.30); color:#7a4d00}
    .badge.warn .dot{background:var(--warn)}
    .badge.danger{background: var(--danger-2); border-color: rgba(239,68,68,.28); color:#8b1220}
    .badge.danger .dot{background:var(--danger)}

    /* Matrix */
    .matrix{
      display:grid;
      grid-template-columns: 170px repeat(3, minmax(120px, 1fr));
      border:1px solid var(--line2);
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
    }
    .mcell{
      padding:10px 10px;
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      font-size:12px;
    }
    .mcell.head{
      font-weight:950;
      font-size:10.5px;
      letter-spacing:.2px;
      color:#12304a;
      background: linear-gradient(90deg, var(--blue-2), var(--green-2));
      border-bottom:1px solid var(--line2);
    }
    .mcell.side{
      font-weight:950;
      color:#18324a;
      background:#fbfdff;
    }
    .mpill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      font-size:10.5px;
      font-weight:950;
      white-space:nowrap;
    }
    .mpill.r{background: var(--danger-2); border-color: rgba(239,68,68,.25); color:#8b1220}
    .mpill.y{background: var(--warn-2); border-color: rgba(245,158,11,.25); color:#7a4d00}
    .mpill.g{background: var(--green-2); border-color: rgba(31,157,102,.22); color:#0b5a3a}

    /* Suggestions */
    .suggestions{display:flex;flex-direction:column;gap:10px}
    .sugg{
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:12px 12px;
      background:#fff;
      box-shadow: 0 10px 18px rgba(12,33,66,.06);
    }
    .sugghead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .suggt{font-weight:950;font-size:12px;color:#12304a;margin:0}
    .suggs{font-size:11px;color:var(--muted);margin:6px 0 0;line-height:1.35}
    .suggmeta{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center;margin-top:10px}
    .suggbtns{display:flex;gap:8px;margin-top:10px}
    .suggbtns .btn{padding:9px 10px;border-radius:14px;font-size:12px;width:100%}

    /* Log */
    .log{
      background:#fff;
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:10px 12px;
      max-height: 270px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 11px;
      color:#0f2a3a;
      line-height:1.45;
    }
    .logline{padding:6px 0; border-bottom:1px dashed var(--line)}
    .logline:last-child{border-bottom:none}
    .small{font-size:11px;color:var(--muted);line-height:1.35}
    .foot{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:11px;
    }
    .foot b{color:#12304a}

    /* Views */
    .view{display:none;}
    .view.active{display:block;}

    /* Placeholder pages */
    .placeholder{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .phgrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    .phcard{
      border:1px solid var(--line);
      background:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .phcard h3{margin:0;font-size:12.5px;font-weight:950;color:#12304a}
    .phcard p{margin:8px 0 0;color:var(--muted);font-size:11.5px;line-height:1.35}

    @media (max-width: 1120px){
      .ctx{grid-template-columns: repeat(3, minmax(0, 1fr)); max-width:none; margin-left:0}
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative;height:auto}
      .grid{grid-template-columns: 1fr}
      .phgrid{grid-template-columns: 1fr}
      .subnav{position:relative; top:auto}
    }
    @media (max-width: 560px){
      .topbar{flex-direction:column}
      .actions{width:100%}
      .btn{width:100%}
      .matrix{grid-template-columns: 140px repeat(3, minmax(90px, 1fr));}
    }
  </style>
</head>

<body>
  <div class="app">

    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>HXtos CY</h1>
          <div class="sub">Edi√ß√£o Light ‚Ä¢ Padr√£o Vistoria 7 Pontos</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a href="#dashboard" data-route="dashboard"><span class="ico">D</span>Dashboard</a>
        <a href="#gateiq" data-route="gateiq"><span class="ico">G</span>GateIQ</a>
        <a href="#deckingiq" data-route="deckingiq"><span class="ico">K</span>DeckingIQ</a>
        <a href="#yardiq" data-route="yardiq"><span class="ico">Y</span>YardIQ</a>
        <a href="#dociq" data-route="dociq"><span class="ico">O</span>DocIQ</a>
        <a href="#settings" data-route="settings"><span class="ico">S</span>Settings</a>
      </nav>

      <div class="sidefoot" id="sidefoot">
        <div><b id="sideTitle">YardIQ</b></div>
        <div style="margin-top:6px;" id="sideDesc">
          Matriz operacional para imputar dados e gerar sugest√µes explic√°veis.
        </div>
        <div class="pill">
          Regra-base: <b>3 RTGs</b> por <b>1 STS</b>
        </div>
        <div style="margin-top:8px;">
          Engine atual: rules + scoring (pronto para evoluir p/ ML mantendo rastreabilidade).
        </div>
      </div>
    </aside>

    <main class="main">

      <!-- Dashboard -->
      <section class="view" id="view-dashboard">
        <div class="topbar">
          <div class="crumb">
            <div class="path">HXtos CY / Dashboard</div>
            <p class="title">Dashboard</p>
            <p class="desc">P√°gina de vis√£o geral (placeholder naveg√°vel). Substitua pelos seus KPIs e cards reais.</p>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="location.hash='#yardiq'">Ir para YardIQ</button>
            <button class="btn ghost" onclick="alert('Placeholder: conecte ao seu data layer/TOS.')">A√ß√£o</button>
          </div>
        </div>
        <div class="placeholder">
          <div class="phgrid">
            <div class="phcard"><h3>Vis√£o Operacional</h3><p>KPIs agregados: ocupa√ß√£o, produtividade, filas internas, janelas cr√≠ticas.</p></div>
            <div class="phcard"><h3>Alertas</h3><p>Eventos: risco de spillback, satura√ß√£o de zona, quebra de equipamento.</p></div>
            <div class="phcard"><h3>Atalhos</h3><p>Acesso r√°pido: GateIQ, DeckingIQ, YardIQ, DocIQ.</p></div>
          </div>
        </div>
      </section>

      <!-- GateIQ -->
      <section class="view" id="view-gateiq">
        <div class="topbar">
          <div class="crumb">
            <div class="path">HXtos CY / GateIQ</div>
            <p class="title">GateIQ</p>
            <p class="desc">Placeholder naveg√°vel para o m√≥dulo de gate (regras, exce√ß√µes, inspe√ß√£o, libera√ß√£o).</p>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="location.hash='#yardiq'">Ir para YardIQ</button>
            <button class="btn ghost" onclick="alert('Placeholder: adicione filas, exce√ß√µes e workflow.')">A√ß√£o</button>
          </div>
        </div>
        <div class="placeholder">
          <div class="phgrid">
            <div class="phcard"><h3>Fila & Work Queue</h3><p>Entradas/sa√≠das, agendamentos, picos, valida√ß√µes e bloqueios.</p></div>
            <div class="phcard"><h3>Exce√ß√µes</h3><p>Cria√ß√£o, triagem, inspe√ß√£o, libera√ß√£o e rastreabilidade.</p></div>
            <div class="phcard"><h3>OCR / Camera</h3><p>Integra√ß√£o e eventos (captura, diverg√™ncia, override, auditoria).</p></div>
          </div>
        </div>
      </section>

      <!-- DeckingIQ -->
      <section class="view" id="view-deckingiq">
        <div class="topbar">
          <div class="crumb">
            <div class="path">HXtos CY / DeckingIQ</div>
            <p class="title">DeckingIQ</p>
            <p class="desc">Placeholder naveg√°vel para sugest√µes/approvals e gera√ß√£o de tarefas no DispatchIQ.</p>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="location.hash='#yardiq'">Ir para YardIQ</button>
            <button class="btn ghost" onclick="alert('Placeholder: inserir painel de sugest√µes e aprova√ß√£o.')">A√ß√£o</button>
          </div>
        </div>
        <div class="placeholder">
          <div class="phgrid">
            <div class="phcard"><h3>Sugest√µes</h3><p>Engine: regras/ML, filtros, score e explainability.</p></div>
            <div class="phcard"><h3>Aprova√ß√£o</h3><p>Workflow: aprovar/recusar, motivo, auditoria.</p></div>
            <div class="phcard"><h3>Dispatch</h3><p>Gera√ß√£o de tarefas e prioriza√ß√£o por regi√£o/equipamento.</p></div>
          </div>
        </div>
      </section>

      <!-- YardIQ -->
      <section class="view" id="view-yardiq">

        <div class="topbar">
          <div class="crumb">
            <div class="path">HXtos CY / YardIQ / Controle</div>
            <p class="title">AI Yard Control Matrix</p>
            <p class="desc">
              Impute condi√ß√µes operacionais (STS/RTG/Zonas) e gere recomenda√ß√µes com impacto e explica√ß√£o ‚Äî alinhado √† estrat√©gia 3:1 e anticongestionamento por regi√µes.
            </p>
          </div>

          <div class="ctx">
            <div class="field">
              <label>Terminal / Site</label>
              <input id="ctxTerminal" value="Terminal X / Site A" />
            </div>
            <div class="field">
              <label>Servi√ßo / Janela</label>
              <input id="ctxService" value="SERV-NE-021" />
            </div>
            <div class="field">
              <label>Turno</label>
              <select id="ctxShift">
                <option>1¬∫ Turno</option>
                <option selected>2¬∫ Turno</option>
                <option>3¬∫ Turno</option>
              </select>
            </div>
            <div class="field">
              <label>Hora de refer√™ncia</label>
              <input id="ctxTime" type="time" value="14:30" />
            </div>
            <div class="field">
              <label>STSs ativos</label>
              <input id="ctxSTSActive" type="number" min="0" step="1" value="2" />
            </div>
            <div class="field">
              <label>Modo</label>
              <select id="ctxMode">
                <option selected>Opera√ß√£o</option>
                <option>Simula√ß√£o</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnRecalc">Gerar sugest√µes</button>
            <button class="btn good" id="btnApplyAll">Aplicar (Top 1)</button>
            <button class="btn ghost" id="btnReset">Reset (demo)</button>
          </div>
        </div>

        <!-- Internal navigation (tabs) -->
        <div class="subnav" id="yardSubnav">
          <div class="tabs" id="yardTabs">
            <a class="tab" href="#yardiq?tab=inputs" data-tab="inputs"><span class="t"></span>Inputs</a>
            <a class="tab green" href="#yardiq?tab=matrix" data-tab="matrix"><span class="t"></span>Matriz</a>
            <a class="tab warn" href="#yardiq?tab=suggestions" data-tab="suggestions"><span class="t"></span>Sugest√µes</a>
            <a class="tab" href="#yardiq?tab=log" data-tab="log"><span class="t"></span>Log</a>
          </div>

          <div class="subtools">
            <button class="btn" id="btnGoInputs">Ir p/ Inputs</button>
            <button class="btn primary" id="btnGoMatrix">Ir p/ Matriz</button>
            <button class="btn good" id="btnGoSuggs">Ir p/ Sugest√µes</button>
          </div>
        </div>

        <!-- Content -->
        <div class="grid">
          <!-- LEFT -->
          <section style="display:flex; flex-direction:column; gap:14px;">

            <div class="card section" id="sec-inputs">
              <div class="cardhead">
                <div>
                  <h2>Estado do Sistema</h2>
                  <div class="hint">KPIs sintetizados a partir dos inputs e da regra 3:1.</div>
                </div>
                <div class="badges" id="systemBadges"></div>
              </div>
              <div class="cardbody">
                <div class="kpirow">
                  <div class="kpi">
                    <div class="k">RTGs operacionais</div>
                    <div class="v"><span id="kpiRTGOp">0</span></div>
                    <div class="s">Exclui RTGs ‚ÄúQuebrado‚Äù.</div>
                  </div>
                  <div class="kpi">
                    <div class="k">RTGs necess√°rios</div>
                    <div class="v"><span id="kpiRTGNeed">0</span></div>
                    <div class="s">= STSs ativos √ó 3.</div>
                  </div>
                  <div class="kpi">
                    <div class="k">Risco de spillback</div>
                    <div class="v"><span id="kpiRisk">‚Äî</span></div>
                    <div class="s">Press√£o no Hot Yard (estimado).</div>
                  </div>
                </div>
                <div class="foot">
                  <div><b>Nota:</b> engine explic√°vel (rules + scoring), pronto para ML mantendo rastreabilidade.</div>
                  <div class="small">Dica: use a navega√ß√£o interna acima.</div>
                </div>
              </div>
            </div>

            <!-- STS -->
            <div class="card section" id="sec-sts">
              <div class="cardhead">
                <div>
                  <h2>Inputs ‚Äî STS</h2>
                  <div class="hint">MPH planejado x real e status.</div>
                </div>
                <div class="rowtools">
                  <button class="iconbtn blue" id="addSTS">+ STS</button>
                </div>
              </div>
              <div class="cardbody" style="padding:0">
                <table>
                  <thead>
                    <tr>
                      <th style="width:120px">STS</th>
                      <th style="width:170px">MPH planejado</th>
                      <th style="width:170px">MPH real</th>
                      <th>Status</th>
                      <th style="width:90px; text-align:right">A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="stsBody"></tbody>
                </table>
              </div>
            </div>

            <!-- ZONES -->
            <div class="card section" id="sec-zones">
              <div class="cardhead">
                <div>
                  <h2>Inputs ‚Äî Zonas do P√°tio</h2>
                  <div class="hint">Capacidade / ocupa√ß√£o para stress por regi√£o.</div>
                </div>
                <div class="small">Hot / Intermedi√°ria / Fria (anticongestionamento + conting√™ncia)</div>
              </div>
              <div class="cardbody" style="padding:0">
                <table>
                  <thead>
                    <tr>
                      <th>Zona</th>
                      <th style="width:180px">Capacidade (%)</th>
                      <th style="width:180px">Ocupa√ß√£o (%)</th>
                      <th style="width:170px">Stress</th>
                    </tr>
                  </thead>
                  <tbody id="zonesBody"></tbody>
                </table>
              </div>
            </div>

            <!-- RTG -->
            <div class="card section" id="sec-rtgs">
              <div class="cardhead">
                <div>
                  <h2>Inputs ‚Äî RTGs</h2>
                  <div class="hint">Regi√£o atual, utiliza√ß√£o e status.</div>
                </div>
                <div class="rowtools">
                  <button class="iconbtn green" id="addRTG">+ RTG</button>
                </div>
              </div>
              <div class="cardbody" style="padding:0">
                <table>
                  <thead>
                    <tr>
                      <th style="width:120px">RTG</th>
                      <th style="width:180px">Regi√£o atual</th>
                      <th style="width:180px">Utiliza√ß√£o (%)</th>
                      <th>Status</th>
                      <th style="width:90px; text-align:right">A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="rtgBody"></tbody>
                </table>
              </div>
            </div>

            <!-- MATRIX -->
            <div class="card section" id="sec-matrix">
              <div class="cardhead">
                <div>
                  <h2>Zone √ó RTG ‚Äî Control Matrix</h2>
                  <div class="hint">Recomenda√ß√£o por zona (calculada). üü¢ recomendado ‚Ä¢ üü° poss√≠vel ‚Ä¢ üî¥ evitar</div>
                </div>
                <div class="small">Base: regra 3:1, stress de zona, utiliza√ß√£o RTG, falhas e buffer</div>
              </div>
              <div class="cardbody">
                <div id="matrix" class="matrix"></div>
              </div>
            </div>

          </section>

          <!-- RIGHT -->
          <section style="display:flex; flex-direction:column; gap:14px;">

            <div class="card section" id="sec-suggestions">
              <div class="cardhead">
                <div>
                  <h2>Sugest√µes do Engine</h2>
                  <div class="hint">A√ß√µes recomendadas + impacto + explica√ß√£o.</div>
                </div>
                <div class="badges" id="suggBadges"></div>
              </div>
              <div class="cardbody">
                <div class="suggestions" id="suggestions"></div>
              </div>
            </div>

            <div class="card section" id="sec-log">
              <div class="cardhead">
                <div>
                  <h2>Explainability & Decision Log</h2>
                  <div class="hint">Rastreabilidade da decis√£o (opera√ß√£o/simula√ß√£o).</div>
                </div>
                <div class="small">Aplicar sugest√£o registra a decis√£o</div>
              </div>
              <div class="cardbody">
                <div class="log" id="log"></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                  <button class="btn" id="btnExportLog">Exportar Log (TXT)</button>
                  <button class="btn" id="btnClearLog">Limpar Log</button>
                </div>
                <div class="small" style="margin-top:10px;">
                  *Engine atual = <b>rules + scoring</b>. Evolu√ß√£o para ML mant√©m os mesmos ‚Äúhooks‚Äù de explica√ß√£o.
                </div>
              </div>
            </div>

          </section>
        </div>
      </section>

      <!-- DocIQ -->
      <section class="view" id="view-dociq">
        <div class="topbar">
          <div class="crumb">
            <div class="path">HXtos CY / DocIQ</div>
            <p class="title">DocIQ</p>
            <p class="desc">Placeholder naveg√°vel para upload/valida√ß√£o/bloqueios/aprova√ß√£o.</p>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="location.hash='#yardiq'">Ir para YardIQ</button>
            <button class="btn ghost" onclick="alert('Placeholder: inserir painel de documentos + valida√ß√£o.')">A√ß√£o</button>
          </div>
        </div>
        <div class="placeholder">
          <div class="phgrid">
            <div class="phcard"><h3>Upload</h3><p>NF-e, CE/BL, anexos operacionais com v√≠nculo ao cont√™iner.</p></div>
            <div class="phcard"><h3>Valida√ß√£o</h3><p>Regras, bloqueios, diverg√™ncia e trilha de aprova√ß√£o.</p></div>
            <div class="phcard"><h3>Auditoria</h3><p>Log, justificativas e exporta√ß√µes.</p></div>
          </div>
        </div>
      </section>

      <!-- Settings -->
      <section class="view" id="view-settings">
        <div class="topbar">
          <div class="crumb">
            <div class="path">HXtos CY / Settings</div>
            <p class="title">Settings</p>
            <p class="desc">Placeholder naveg√°vel: par√¢metros do engine, limiares e perfis.</p>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="location.hash='#yardiq'">Ir para YardIQ</button>
            <button class="btn ghost" onclick="alert('Placeholder: aqui entram thresholds e pesos.')">A√ß√£o</button>
          </div>
        </div>
        <div class="placeholder">
          <div class="phgrid">
            <div class="phcard"><h3>Thresholds</h3><p>Stress de zona, risco spillback, limites de aloca√ß√£o.</p></div>
            <div class="phcard"><h3>Pesos</h3><p>Zone weights, mismatch penalty, health factor.</p></div>
            <div class="phcard"><h3>Perfis</h3><p>Operador, Supervisor, Planejamento, Auditoria.</p></div>
          </div>
        </div>
      </section>

    </main>
  </div>

<script>
  // -----------------------------
  // Router (hash navigation) + query parsing
  // -----------------------------
  const ROUTES = {
    dashboard: { title:"Dashboard", desc:"Vis√£o geral (placeholder naveg√°vel)." },
    gateiq:    { title:"GateIQ", desc:"Fluxos de gate (placeholder)." },
    deckingiq: { title:"DeckingIQ", desc:"Sugest√µes e aprova√ß√£o (placeholder)." },
    yardiq:    { title:"YardIQ", desc:"Matriz operacional com engine de sugest√µes (tela completa)." },
    dociq:     { title:"DocIQ", desc:"Upload/valida√ß√£o/aprova√ß√£o (placeholder)." },
    settings:  { title:"Settings", desc:"Par√¢metros do engine (placeholder)." }
  };

  function parseHash(){
    // Supports:
    // #yardiq
    // #yardiq?tab=matrix
    const raw = (location.hash || "#yardiq").slice(1);
    const [path, qs] = raw.split("?");
    const params = {};
    if(qs){
      qs.split("&").forEach(p=>{
        const [k,v] = p.split("=");
        if(k) params[decodeURIComponent(k)] = decodeURIComponent(v||"");
      });
    }
    return { route: ROUTES[path] ? path : "yardiq", params };
  }

  function setHash(route, params={}){
    const q = Object.keys(params).length
      ? "?" + Object.entries(params).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&")
      : "";
    location.hash = `#${route}${q}`;
  }

  function setActiveRoute(route){
    document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
    const view = document.getElementById(`view-${route}`);
    if(view) view.classList.add("active");

    document.querySelectorAll(".nav a").forEach(a=>{
      a.classList.toggle("active", a.dataset.route === route);
    });

    const s = ROUTES[route];
    document.getElementById("sideTitle").textContent = s.title;
    document.getElementById("sideDesc").textContent = s.desc;

    if(route === "yardiq"){
      setTimeout(()=> {
        if(typeof renderAll === "function") renderAll(false);
        syncYardTabsFromHash();
      }, 0);
    }
  }

  window.addEventListener("hashchange", ()=>{
    const {route} = parseHash();
    setActiveRoute(route);
  });

  // -----------------------------
  // YardIQ internal navigation
  // -----------------------------
  const TAB_TO_SECTION = {
    inputs: "sec-inputs",
    matrix: "sec-matrix",
    suggestions: "sec-suggestions",
    log: "sec-log"
  };

  function activateYardTab(tab){
    // highlight tabs
    document.querySelectorAll("#yardTabs .tab").forEach(t=>{
      t.classList.toggle("active", t.dataset.tab === tab);
    });
  }

  function scrollToSectionByTab(tab){
    const id = TAB_TO_SECTION[tab] || "sec-inputs";
    const el = document.getElementById(id);
    if(el){
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }
  }

  function syncYardTabsFromHash(){
    const {route, params} = parseHash();
    if(route !== "yardiq") return;
    const tab = (params.tab || "inputs").toLowerCase();
    activateYardTab(tab);
    // only auto-scroll when tab explicitly set
    if(params.tab) scrollToSectionByTab(tab);
  }

  // IntersectionObserver to auto-update active tab while scrolling inside YardIQ
  let yardObserver = null;
  function initYardObserver(){
    if(yardObserver) return;
    const targets = Object.values(TAB_TO_SECTION).map(id=>document.getElementById(id)).filter(Boolean);
    if(!targets.length) return;

    yardObserver = new IntersectionObserver((entries)=>{
      // pick the most visible section
      const visible = entries
        .filter(e=>e.isIntersecting)
        .sort((a,b)=> b.intersectionRatio - a.intersectionRatio)[0];
      if(!visible) return;

      const id = visible.target.id;
      const tab = Object.keys(TAB_TO_SECTION).find(k=>TAB_TO_SECTION[k]===id) || "inputs";
      activateYardTab(tab);

      // update hash without scrolling jump (replaceState-like)
      const {route, params} = parseHash();
      if(route==="yardiq"){
        const current = (params.tab||"").toLowerCase();
        if(current !== tab){
          const q = `#yardiq?tab=${encodeURIComponent(tab)}`;
          history.replaceState(null, "", q);
        }
      }
    }, { threshold: [0.25, 0.40, 0.55] });

    targets.forEach(t=>yardObserver.observe(t));
  }

  function wireYardInternalControls(){
    const b1 = document.getElementById("btnGoInputs");
    const b2 = document.getElementById("btnGoMatrix");
    const b3 = document.getElementById("btnGoSuggs");

    if(b1) b1.onclick = ()=> setHash("yardiq",{tab:"inputs"});
    if(b2) b2.onclick = ()=> setHash("yardiq",{tab:"matrix"});
    if(b3) b3.onclick = ()=> setHash("yardiq",{tab:"suggestions"});

    // tabs already have href; enhance for smooth scroll + state
    document.querySelectorAll("#yardTabs .tab").forEach(a=>{
      a.addEventListener("click",(ev)=>{
        ev.preventDefault();
        const tab = a.dataset.tab;
        setHash("yardiq",{tab});
      });
    });
  }

  // -----------------------------
  // YardIQ engine (IA explic√°vel: rules + scoring)
  // -----------------------------
  const ZONES = ["Hot Yard", "Intermedi√°ria", "Fria"];
  const STATUS_RTG = ["Operacional", "Lento", "Quebrado"];
  const STATUS_STS = ["Normal", "Pico", "Restri√ß√£o"];

  const state = {
    sts: [
      { id:"STS-01", mphPlan: 28, mphReal: 30, status:"Pico" },
      { id:"STS-02", mphPlan: 26, mphReal: 25, status:"Normal" }
    ],
    zones: [
      { name:"Hot Yard", capacity: 100, occupancy: 84 },
      { name:"Intermedi√°ria", capacity: 100, occupancy: 68 },
      { name:"Fria", capacity: 100, occupancy: 42 }
    ],
    rtgs: [
      { id:"RTG-01", zone:"Hot Yard", util: 78, status:"Operacional" },
      { id:"RTG-02", zone:"Hot Yard", util: 82, status:"Operacional" },
      { id:"RTG-03", zone:"Intermedi√°ria", util: 64, status:"Operacional" },
      { id:"RTG-04", zone:"Intermedi√°ria", util: 58, status:"Operacional" },
      { id:"RTG-05", zone:"Fria", util: 35, status:"Operacional" },
      { id:"RTG-06", zone:"Fria", util: 0, status:"Lento" }
    ],
    log: []
  };

  const $ = (id)=>document.getElementById(id);
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function zoneStress(occ){
    if (occ >= 85) return { level:"Cr√≠tico", tag:"danger" };
    if (occ >= 70) return { level:"Aten√ß√£o", tag:"warn" };
    return { level:"OK", tag:"ok" };
  }
  function rtgHealth(status){
    if(status==="Quebrado") return 0;
    if(status==="Lento") return 0.65;
    return 1.0;
  }
  function stsPressureFactor(status){
    if(status==="Pico") return 1.15;
    if(status==="Restri√ß√£o") return 0.80;
    return 1.0;
  }

  function escapeHTML(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[s]));
  }

  function addLog(line){
    const ts = new Date();
    const time = ts.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    state.log.unshift(`[${time}] ${line}`);
    renderLog();
  }

  function badge(tag, label){
    const cls = tag==="ok" ? "badge ok" : tag==="warn" ? "badge warn" : "badge danger";
    return `<span class="${cls}"><span class="dot"></span>${label}</span>`;
  }
  function mpill(tag, text){
    const cls = tag==="g" ? "g" : tag==="y" ? "y" : "r";
    return `<span class="mpill ${cls}">${text}</span>`;
  }

  function renderSTS(){
    const body = $("stsBody"); if(!body) return;
    body.innerHTML = "";
    state.sts.forEach((row, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="cell-mini"><input value="${row.id}" data-k="id" data-t="sts" data-i="${idx}" /></td>
        <td class="cell-mini"><input type="number" min="0" step="1" value="${row.mphPlan}" data-k="mphPlan" data-t="sts" data-i="${idx}" /></td>
        <td class="cell-mini"><input type="number" min="0" step="1" value="${row.mphReal}" data-k="mphReal" data-t="sts" data-i="${idx}" /></td>
        <td class="cell-mini">
          <select data-k="status" data-t="sts" data-i="${idx}">
            ${STATUS_STS.map(s=>`<option ${s===row.status?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td style="text-align:right">
          <button class="iconbtn danger" title="Remover" data-del="sts" data-i="${idx}">‚Äì</button>
        </td>
      `;
      body.appendChild(tr);
    });
  }

  function renderZones(){
    const body = $("zonesBody"); if(!body) return;
    body.innerHTML = "";
    state.zones.forEach((z, idx)=>{
      const st = zoneStress(z.occupancy);
      const tag = st.tag;
      const badgeTxt = tag==="ok" ? "OK" : tag==="warn" ? "Aten√ß√£o" : "Cr√≠tico";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${z.name}</b></td>
        <td class="cell-mini">
          <input type="number" min="0" max="100" step="1" value="${z.capacity}"
            data-k="capacity" data-t="zones" data-i="${idx}" />
        </td>
        <td class="cell-mini">
          <input type="number" min="0" max="100" step="1" value="${z.occupancy}"
            data-k="occupancy" data-t="zones" data-i="${idx}" />
        </td>
        <td>${badge(tag, `${badgeTxt} ‚Ä¢ ${z.occupancy}%`)}</td>
      `;
      body.appendChild(tr);
    });
  }

  function renderRTGs(){
    const body = $("rtgBody"); if(!body) return;
    body.innerHTML = "";
    state.rtgs.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="cell-mini"><input value="${r.id}" data-k="id" data-t="rtgs" data-i="${idx}" /></td>
        <td class="cell-mini">
          <select data-k="zone" data-t="rtgs" data-i="${idx}">
            ${ZONES.map(z=>`<option ${z===r.zone?"selected":""}>${z}</option>`).join("")}
          </select>
        </td>
        <td class="cell-mini"><input type="number" min="0" max="100" step="1" value="${r.util}" data-k="util" data-t="rtgs" data-i="${idx}" /></td>
        <td class="cell-mini">
          <select data-k="status" data-t="rtgs" data-i="${idx}">
            ${STATUS_RTG.map(s=>`<option ${s===r.status?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td style="text-align:right">
          <button class="iconbtn danger" title="Remover" data-del="rtgs" data-i="${idx}">‚Äì</button>
        </td>
      `;
      body.appendChild(tr);
    });
  }

  function renderMatrix(reco){
    const m = $("matrix"); if(!m) return;
    m.innerHTML = "";
    m.insertAdjacentHTML("beforeend", `<div class="mcell head">RTG ‚Üì / Zona ‚Üí</div>`);
    ZONES.forEach(z=>m.insertAdjacentHTML("beforeend", `<div class="mcell head">${z}</div>`));
    state.rtgs.forEach(r=>{
      m.insertAdjacentHTML("beforeend", `<div class="mcell side">${r.id}</div>`);
      ZONES.forEach(z=>{
        const tag = (reco[r.id] && reco[r.id][z]) ? reco[r.id][z] : "r";
        const text = tag==="g" ? "üü¢ Recomendado" : tag==="y" ? "üü° Poss√≠vel" : "üî¥ Evitar";
        m.insertAdjacentHTML("beforeend", `<div class="mcell">${mpill(tag, text)}</div>`);
      });
    });
  }

  function renderBadges(system){
    const sb = $("systemBadges"), sgb = $("suggBadges");
    if(sb) sb.innerHTML = [
      badge(system.capacityTag, `Capacidade: ${system.capacityLabel}`),
      badge(system.rtgTag, `RTGs: ${system.rtgLabel}`),
      badge(system.riskTag, `Risco: ${system.riskLabel}`)
    ].join("");

    if(sgb) sgb.innerHTML = [
      badge(system.riskTag, `Spillback: ${system.riskLabel}`),
      badge(system.capacityTag, `Hot Yard: ${system.hotOcc}%`)
    ].join("");
  }

  function renderKPIs(system){
    const a=$("kpiRTGOp"), b=$("kpiRTGNeed"), c=$("kpiRisk");
    if(a) a.textContent = system.rtgOperational;
    if(b) b.textContent = system.rtgNeed;
    if(c) c.textContent = system.riskLabel;
  }

  function renderSuggestions(list){
    const el = $("suggestions"); if(!el) return;
    el.innerHTML = "";
    if(!list.length){
      el.innerHTML = `<div class="small">Nenhuma sugest√£o no momento. Ajuste inputs ou clique em <b>Gerar sugest√µes</b>.</div>`;
      return;
    }
    list.forEach((s, idx)=>{
      const card = document.createElement("div");
      card.className = "sugg";
      card.innerHTML = `
        <div class="sugghead">
          <div>
            <p class="suggt">${s.title}</p>
            <p class="suggs">${s.body}</p>
          </div>
          <div style="text-align:right">${badge(s.tag, `${s.confidence}`)}</div>
        </div>
        <div class="suggmeta">
          ${badge("ok", `Impacto: ${s.impact}`)}
          ${badge("warn", `Zona: ${s.zoneFocus}`)}
          ${badge("ok", `Motivos: ${s.reasons.length}`)}
        </div>
        <div class="small" style="margin-top:10px">
          <b>Explainability:</b><br/>
          ${s.reasons.map(r=>`‚Ä¢ ${r}`).join("<br/>")}
        </div>
        <div class="suggbtns">
          <button class="btn good" data-apply="${idx}">Aplicar</button>
          <button class="btn primary" data-sim="${idx}">Simular</button>
          <button class="btn" data-ignore="${idx}">Ignorar</button>
        </div>
      `;
      el.appendChild(card);
    });
  }

  function renderLog(){
    const el = $("log"); if(!el) return;
    if(!state.log.length){
      el.innerHTML = `<div class="logline" style="color:var(--muted)">Sem eventos registrados.</div>`;
      return;
    }
    el.innerHTML = state.log.map(l=>`<div class="logline">${escapeHTML(l)}</div>`).join("");
  }

  function computeSystem(){
    const stsActive = Number(($("ctxSTSActive")?.value)||0);
    const rtgNeed = stsActive * 3;
    const rtgOperational = state.rtgs.filter(r=>r.status!=="Quebrado").length;

    const hot = state.zones.find(z=>z.name==="Hot Yard");
    const inter = state.zones.find(z=>z.name==="Intermedi√°ria");
    const cold = state.zones.find(z=>z.name==="Fria");

    const hotStress = zoneStress(hot.occupancy);
    const interStress = zoneStress(inter.occupancy);

    const pressure = state.sts.reduce((acc, s)=>{
      const ratio = (s.mphReal>0 && s.mphPlan>0) ? (s.mphReal / s.mphPlan) : 1.0;
      return acc + ratio * stsPressureFactor(s.status);
    }, 0) / Math.max(1, state.sts.length);

    const shortage = Math.max(0, rtgNeed - rtgOperational);
    const shortageFactor = shortage / Math.max(1, rtgNeed);
    const hotOccFactor = clamp(hot.occupancy/100, 0, 1);
    const riskScore = clamp(0.45*shortageFactor + 0.40*hotOccFactor + 0.15*clamp((pressure-1)*1.2, 0, 1), 0, 1);

    let riskLabel = "Baixo", riskTag = "ok";
    if(riskScore >= 0.66){ riskLabel="Alto"; riskTag="danger"; }
    else if(riskScore >= 0.40){ riskLabel="M√©dio"; riskTag="warn"; }

    let capacityLabel="OK", capacityTag="ok";
    if(hotStress.tag==="danger" || interStress.tag==="danger"){ capacityLabel="Cr√≠tico"; capacityTag="danger"; }
    else if(hotStress.tag==="warn" || interStress.tag==="warn"){ capacityLabel="Aten√ß√£o"; capacityTag="warn"; }

    let rtgLabel = (rtgOperational>=rtgNeed) ? "Coberto" : `Falta ${rtgNeed-rtgOperational}`;
    let rtgTag = (rtgOperational>=rtgNeed) ? "ok" : (rtgOperational>=rtgNeed-1 ? "warn" : "danger");

    return {
      stsActive, rtgNeed, rtgOperational,
      hotOcc: hot.occupancy,
      interOcc: inter.occupancy,
      coldOcc: cold.occupancy,
      pressure,
      shortage,
      riskScore, riskLabel, riskTag,
      capacityLabel, capacityTag,
      rtgLabel, rtgTag
    };
  }

  function computeMatrix(system){
    const zoneWeights = {"Hot Yard":1.15, "Intermedi√°ria":1.00, "Fria":0.85};
    const zonePenalty = {};
    state.zones.forEach(z=>{
      const st = zoneStress(z.occupancy);
      zonePenalty[z.name] = st.tag==="danger" ? 0.30 : st.tag==="warn" ? 0.18 : 0.05;
    });

    const reco = {};
    state.rtgs.forEach(r=>{
      reco[r.id] = {};
      ZONES.forEach(z=>{
        const health = rtgHealth(r.status);
        const avail = (1 - clamp(r.util/100, 0, 1));
        const base = avail * health * zoneWeights[z] * (1 - zonePenalty[z]);

        const mismatch = (r.zone===z) ? 0 : (r.zone==="Fria" && z==="Hot Yard") ? 0.10 :
                         (r.zone==="Hot Yard" && z==="Fria") ? 0.10 : 0.06;

        const hotOver = (z==="Hot Yard" && system.hotOcc>=85) ? 0.10 : 0.0;
        const score = base - mismatch - hotOver;

        let tag="r";
        if(r.status==="Quebrado") tag="r";
        else if(score >= 0.58) tag="g";
        else if(score >= 0.40) tag="y";
        else tag="r";

        if(z==="Hot Yard" && system.hotOcc>=92) tag="r";
        reco[r.id][z] = tag;
      });
    });
    return reco;
  }

  function buildSuggestions(system){
    const sugg = [];

    if(system.shortage > 0){
      const candidates = state.rtgs
        .filter(r=>r.status!=="Quebrado")
        .sort((a,b)=> (a.util - b.util));

      sugg.push({
        tag: system.shortage>=2 ? "danger" : "warn",
        confidence: system.shortage>=2 ? "Confian√ßa: Alta" : "Confian√ßa: M√©dia",
        zoneFocus: "Hot Yard / Intermedi√°ria",
        impact: `Protege STS (${system.shortage} RTG(s) em falta)`,
        title: `Cobertura 3:1 insuficiente ‚Äî acionar conting√™ncia`,
        body: `RTGs operacionais (${system.rtgOperational}) abaixo do necess√°rio (${system.rtgNeed}). Recomenda-se ativar RTG(s) de conting√™ncia e reduzir tarefas n√£o cr√≠ticas (reshuffles).`,
        reasons: [
          `Regra 3:1: STSs ativos = ${system.stsActive} ‚Üí RTGs necess√°rios = ${system.rtgNeed}.`,
          `RTGs operacionais (exclui quebrados) = ${system.rtgOperational}.`,
          `Risco de spillback estimado: ${system.riskLabel}.`
        ],
        apply: { type:"policy", action:"prioritize_hot", pick: candidates.slice(0,2).map(r=>r.id) }
      });
    }

    if(system.hotOcc >= 85){
      const target = (system.interOcc <= 75) ? "Intermedi√°ria" : "Fria";
      const tag = (system.hotOcc>=92) ? "danger" : "warn";
      const conf = (system.hotOcc>=92) ? "Confian√ßa: Alta" : "Confian√ßa: M√©dia";

      sugg.push({
        tag, confidence: conf,
        zoneFocus: target,
        impact: `Reduz press√£o no Hot Yard`,
        title: `Hot Yard sob stress ‚Äî redirecionar drops temporariamente`,
        body: `Hot Yard com ${system.hotOcc}% de ocupa√ß√£o. Redirecionar novos drops para ${target} preserva buffer de cais e reduz filas internas.`,
        reasons: [
          `Hot Yard ‚â• 85% aumenta risco de spillback para o cais.`,
          `${target} oferece margem (ocupa√ß√£o: ${target==="Intermedi√°ria"?system.interOcc:system.coldOcc}%).`,
          `Estrat√©gia anticongestionamento exige rota alternativa ativa.`
        ],
        apply: { type:"policy", action:"redirect", to: target }
      });
    }

    if(system.riskScore >= 0.40){
      const movable = state.rtgs
        .filter(r=>r.status!=="Quebrado")
        .filter(r=>r.zone!=="Hot Yard")
        .sort((a,b)=> (a.util - b.util));

      if(movable.length){
        const pick = movable[0];
        sugg.push({
          tag: system.riskScore>=0.66 ? "danger" : "warn",
          confidence: system.riskScore>=0.66 ? "Confian√ßa: Alta" : "Confian√ßa: M√©dia",
          zoneFocus: "Hot Yard",
          impact: `Aumenta elasticidade no interface cais‚Äìp√°tio`,
          title: `Rebalanceamento ‚Äî deslocar ${pick.id} para Hot Yard`,
          body: `Com risco ${system.riskLabel} e RTG ${pick.id} com baixa utiliza√ß√£o (${pick.util}%), recomenda-se deslocamento para Hot Yard como secund√°rio para absorver pico.`,
          reasons: [
            `Risco agregado: shortage (${system.shortage}) + Hot Yard (${system.hotOcc}%) + press√£o STS.`,
            `${pick.id} tem baixa utiliza√ß√£o e est√° dispon√≠vel (${pick.status}).`,
            `Intermedi√°ria/Fria devem suportar conting√™ncia do Hot Yard quando necess√°rio.`
          ],
          apply: { type:"move_rtg", rtgId: pick.id, toZone:"Hot Yard" }
        });
      }
    }

    if(system.interOcc >= 80){
      sugg.push({
        tag: system.interOcc>=90 ? "danger" : "warn",
        confidence: system.interOcc>=90 ? "Confian√ßa: Alta" : "Confian√ßa: M√©dia",
        zoneFocus: "Intermedi√°ria",
        impact: `Libera capacidade para fluxo cr√≠tico`,
        title: `Intermedi√°ria congestionando ‚Äî congelar tarefas n√£o cr√≠ticas`,
        body: `Intermedi√°ria com ${system.interOcc}% de ocupa√ß√£o. Congelar reshuffles e realoca√ß√µes n√£o cr√≠ticas reduz conflito de prioridades e estabiliza o fluxo.`,
        reasons: [
          `Zona intermedi√°ria √© o ‚Äúpulm√£o‚Äù. Satura√ß√£o reduz resili√™ncia.`,
          `Tarefas n√£o cr√≠ticas competem por RTG e vias internas.`,
          `Conting√™ncia depende de margem na Intermedi√°ria.`
        ],
        apply: { type:"policy", action:"freeze_noncritical", zone:"Intermedi√°ria" }
      });
    }

    if(!sugg.length){
      sugg.push({
        tag:"ok",
        confidence:"Confian√ßa: Alta",
        zoneFocus:"‚Äî",
        impact:"Opera√ß√£o est√°vel",
        title:"Condi√ß√µes est√°veis ‚Äî manter estrat√©gia atual",
        body:"Cobertura 3:1 atendida e zonas abaixo do limiar de stress. Recomenda-se manter a aloca√ß√£o e monitorar varia√ß√µes de 15‚Äì30 min.",
        reasons:[
          `RTGs operacionais ‚â• RTGs necess√°rios (${system.rtgOperational} ‚â• ${system.rtgNeed}).`,
          `Hot Yard abaixo de 85% (atual: ${system.hotOcc}%).`,
          `Risco agregado: ${system.riskLabel}.`
        ],
        apply: { type:"noop" }
      });
    }

    return sugg.slice(0, 3);
  }

  function applySuggestion(s){
    const mode = $("ctxMode")?.value || "Opera√ß√£o";
    const prefix = (mode==="Simula√ß√£o") ? "SIMULA√á√ÉO" : "APLICADO";
    if(!s || !s.apply) return;

    if(s.apply.type==="move_rtg"){
      const r = state.rtgs.find(x=>x.id===s.apply.rtgId);
      if(r){
        const from = r.zone;
        r.zone = s.apply.toZone;
        addLog(`${prefix}: mover ${r.id} de ${from} ‚Üí ${r.zone} | Motivo: ${s.title}`);
      }
    } else if(s.apply.type==="policy"){
      addLog(`${prefix}: pol√≠tica '${s.apply.action}' | Foco: ${s.zoneFocus} | Motivo: ${s.title}`);
    } else if(s.apply.type==="noop"){
      addLog(`${prefix}: manter estrat√©gia | ${s.title}`);
    }
    renderAll(true);
  }

  function ignoreSuggestion(s){
    const mode = $("ctxMode")?.value || "Opera√ß√£o";
    const prefix = (mode==="Simula√ß√£o") ? "SIMULA√á√ÉO" : "REGISTRO";
    addLog(`${prefix}: ignorada sugest√£o | ${s.title}`);
  }
  function simulateSuggestion(s){
    const mode = $("ctxMode")?.value || "Opera√ß√£o";
    addLog(`${mode==="Simula√ß√£o" ? "SIMULA√á√ÉO" : "SIMULA√á√ÉO (opera√ß√£o)"}: avaliar '${s.title}'`);
  }

  function renderAll(fromUser=false){
    if(!document.getElementById("view-yardiq")) return;

    renderSTS();
    renderZones();
    renderRTGs();

    const system = computeSystem();
    const reco = computeMatrix(system);
    const suggestions = buildSuggestions(system);

    renderBadges(system);
    renderKPIs(system);
    renderMatrix(reco);
    renderSuggestions(suggestions);

    window.__latest = {system, reco, suggestions};

    if(fromUser){
      addLog(`Recalcular: STSs=${system.stsActive}, RTGs op=${system.rtgOperational}, RTGs need=${system.rtgNeed}, Hot=${system.hotOcc}%, Risco=${system.riskLabel}`);
    }
  }

  // YardIQ events (delegation)
  document.addEventListener("input", (e)=>{
    const {route} = parseHash();
    if(route !== "yardiq") return;

    const t = e.target;
    const k = t.getAttribute("data-k");
    const type = t.getAttribute("data-t");
    const i = t.getAttribute("data-i");
    if(!k || !type || i===null) return;

    const idx = Number(i);
    let v = t.value;
    if(["mphPlan","mphReal","capacity","occupancy","util"].includes(k)) v = Number(v||0);

    if(type==="sts") state.sts[idx][k] = v;
    else if(type==="zones") state.zones[idx][k] = v;
    else if(type==="rtgs") state.rtgs[idx][k] = v;

    renderAll(false);
  });

  document.addEventListener("click", (e)=>{
    const {route} = parseHash();
    if(route !== "yardiq") return;

    const del = e.target.getAttribute("data-del");
    const di = e.target.getAttribute("data-i");
    if(del && di!==null){
      const idx = Number(di);
      if(del==="sts") state.sts.splice(idx,1);
      if(del==="rtgs") state.rtgs.splice(idx,1);
      addLog(`Remo√ß√£o: ${del.toUpperCase()} linha #${idx+1}`);
      renderAll(true);
      return;
    }

    const applyIdx = e.target.getAttribute("data-apply");
    if(applyIdx!==null){
      const s = window.__latest?.suggestions?.[Number(applyIdx)];
      applySuggestion(s);
      return;
    }
    const simIdx = e.target.getAttribute("data-sim");
    if(simIdx!==null){
      const s = window.__latest?.suggestions?.[Number(simIdx)];
      simulateSuggestion(s);
      return;
    }
    const ignIdx = e.target.getAttribute("data-ignore");
    if(ignIdx!==null){
      const s = window.__latest?.suggestions?.[Number(ignIdx)];
      ignoreSuggestion(s);
      return;
    }
  });

  function wireYardButtons(){
    const br = $("btnRecalc"), ba = $("btnApplyAll"), bs = $("btnReset");
    const aR = $("addRTG"), aS = $("addSTS");
    const cl = $("btnClearLog"), ex = $("btnExportLog");

    if(br) br.onclick = ()=>renderAll(true);
    if(ba) ba.onclick = ()=>{
      const top = window.__latest?.suggestions?.[0];
      if(top) applySuggestion(top);
    };
    if(aR) aR.onclick = ()=>{
      const n = state.rtgs.length + 1;
      state.rtgs.push({ id:`RTG-${String(n).padStart(2,"0")}`, zone:"Fria", util: 20, status:"Operacional" });
      addLog("Adicionar: RTG (default em Fria como conting√™ncia)");
      renderAll(true);
      // keep tab in inputs
      setHash("yardiq",{tab:"inputs"});
    };
    if(aS) aS.onclick = ()=>{
      const n = state.sts.length + 1;
      state.sts.push({ id:`STS-${String(n).padStart(2,"0")}`, mphPlan: 26, mphReal: 26, status:"Normal" });
      addLog("Adicionar: STS");
      renderAll(true);
      setHash("yardiq",{tab:"inputs"});
    };
    if(bs) bs.onclick = ()=>{
      state.sts = [
        { id:"STS-01", mphPlan: 28, mphReal: 30, status:"Pico" },
        { id:"STS-02", mphPlan: 26, mphReal: 25, status:"Normal" }
      ];
      state.zones = [
        { name:"Hot Yard", capacity: 100, occupancy: 84 },
        { name:"Intermedi√°ria", capacity: 100, occupancy: 68 },
        { name:"Fria", capacity: 100, occupancy: 42 }
      ];
      state.rtgs = [
        { id:"RTG-01", zone:"Hot Yard", util: 78, status:"Operacional" },
        { id:"RTG-02", zone:"Hot Yard", util: 82, status:"Operacional" },
        { id:"RTG-03", zone:"Intermedi√°ria", util: 64, status:"Operacional" },
        { id:"RTG-04", zone:"Intermedi√°ria", util: 58, status:"Operacional" },
        { id:"RTG-05", zone:"Fria", util: 35, status:"Operacional" },
        { id:"RTG-06", zone:"Fria", util: 0, status:"Lento" }
      ];
      addLog("Reset: estado demo restaurado");
      renderAll(true);
      setHash("yardiq",{tab:"inputs"});
    };
    if(cl) cl.onclick = ()=>{ state.log=[]; renderLog(); setHash("yardiq",{tab:"log"}); };
    if(ex) ex.onclick = ()=>{
      const text = state.log.slice().reverse().join("\n");
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "yardiq-ai-yard-control-log.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };
  }

  // Boot
  window.addEventListener("DOMContentLoaded", ()=>{
    if(!location.hash) location.hash = "#yardiq?tab=inputs";
    const {route} = parseHash();
    setActiveRoute(route);

    addLog("Inicializa√ß√£o: app carregado (router + subnav ativo).");

    setTimeout(()=> {
      wireYardButtons();
      wireYardInternalControls();
      initYardObserver();
      if(parseHash().route==="yardiq"){
        renderAll(false);
        syncYardTabsFromHash();
      }
    }, 0);
  });

  window.addEventListener("hashchange", ()=>{
    const {route} = parseHash();
    setActiveRoute(route);
    setTimeout(()=> {
      wireYardButtons();
      wireYardInternalControls();
      initYardObserver();
      if(route==="yardiq"){
        renderAll(false);
        syncYardTabsFromHash();
      }
    }, 0);
  });
</script>
</body>
</html>
